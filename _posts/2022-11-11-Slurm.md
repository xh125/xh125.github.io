---
layout:     post
title:      "Slurm资源管理与作业调度系统在WSL2上的安装配置"
date:       2022-11-1 16:31:00
author:     "Xiehua"
header-img: "img/post-bg-miui6.jpg"
tags:
    - Slurm
    - WSL
---

参考：[中科大超算中心：Slurm资源管理与作业调度系统安装配置 2021-12 文档][1]

## 1. Slurm简介

### 1.1 用途  

Slurm(Simple Linux Utility for Resource Management， [http://slurm.schedmd.com/][2] )是开源的、具有容错性和高度可扩展的Linux集群超级计算系统资源管理和作业调度系统。超级计算系统可利用Slurm对资源和作业进行管理，以避免相互干扰，提高运行效率。所有需运行的作业，无论是用于程序调试还是业务计算，都可以通过交互式并行 `srun` 、批处理式 `sbatch` 或分配式 `salloc` 等命令提交，提交后可以利用相关命令查询作业状态等。

### 1.2 构架
Slurm采用`slurmctld`服务（守护进程）作为中心管理器用于监测资源和作业，为了提高可用性，还可以配置另一个备份冗余管理器。各计算节点需启动`slurmd`守护进程，以便被用于作为远程shell使用：等待作业、执行作业、返回状态、再等待更多作业。`slurmdbd`(Slurm DataBase Daemon)数据库守护进程（非必需，建议采用，也可以记录到纯文本中等），可以将多个`slurm`管理的集群的记账信息记录在同一个数据库中。还可以启用`slurmrestd`(Slurm REST API Daemon)服务（非必需），该服务可以通过REST API与Slurm进行交互，所有功能都对应的API。用户工具包含 `srun` 运行作业、 `scancel` 终止排队中或运行中的作业、 `sinfo` 查看系统状态、 `squeue` 查看作业状态、 `sacct` 查看运行中或结束了的作业及作业步信息等命令。 `sview` 命令可以图形化显示系统和作业状态（可含有网络拓扑）。 `scontrol` 作为管理工具，可以监控、修改集群的配置和状态信息等。用于管理数据库的命令是 `sacctmgr` ，可认证集群、有效用户、有效记账账户等。

![Slurm Components][3]

### 1.3 术语  

- 节点  

  - Hea Node：头节点、管理节点、控制节点，运行slurmctld管理服务的节点。
  - Compute Node：计算节点，运行作业计算任务的节点，需运行slurmd服务。
  - Login Node：用户登录节点，用于用户登录的节点。

  - SlurmDBD Node：SlurmDBD节点、SlurmDBD数据库节点，存储调度策略、记账和作业等信息的节点，需运行slurmdbd服务。

  - 客户节点：含计算节点和用户登录节点。

- 用户
  - account：账户，一个账户可以含有多个用户。

  - user：用户，多个用户可以共享一个账户。

  - bank account：银行账户，对应机时费等。

- 资源
  - GRES：Generic Resource，通用资源。

  - TRES：Trackable RESources，可追踪资源。

  - QOS：Quality of Service，服务质量，作业优先级。

  - association：关联。可利用其实现，如用户的关联不在数据库中，这将阻止用户运行作业。该选项可以阻止用户访问无效账户。

  - Partition：队列、分区。用于对计算节点、作业并行规模、作业时长、用户等进行分组管理，以合理分配资源。

### 1.4 插件
Slurm含有一些通用目的插件可以使用，采用这些插件可以方便地支持多种基础结构，允许利用构建块方式吸纳多种Slurm配置，主要包括如下插件：

- 记账存储(Accounting Storage)：主要用于存储作业历史数据。当采用SlurmDBD时，可以支持有限的基于系统的历史系统状态。  
    
- 账户收集能源(Account Gather Energy)：收集系统中每个作业或节点的能源（电力）消耗，该插件与记账存储Accounting Storage和作业记账收集Job Account Gather插件一起使用。

- 通信认证(Authentication of communications)：提供在Slurm不同组件之间进行认证机制。

- 容器(Containers)：HPC作业负载容器支持及实现。

- 信用(Credential，数字签名生成，Digital Signature Generation)：用于生成电子签名的机制，可用于验证作业步在某节点上具有执行权限。与用于身份验证的插件不同，因为作业步请求从用户的 srun 命令发送，而不是直接从slurmctld守护进程发送，该守护进程将生成作业步凭据及其数字签名。

- 通用资源(Generic Resources)：提供用于控制通用资源（如GPU）的接口。

- 作业提交(Job Submit)：该插件提供特殊控制，以允许站点覆盖作业在提交和更新时提出的需求。

- 作业记账收集(Job Accounting Gather)：收集作业步资源使用数据。

- 作业完成记录(Job Completion Logging)：记录作业完成数据，一般是记账存储插件的子数据集。

- 启动器(Launchers)：控制srun启动任务时的机制。

- MPI：针对多种MPI实现提供不同钩子，可用于设置MPI环境变量等。

- 抢占(Preempt)：决定哪些作业可以抢占其它作业以及所采用的抢占机制。

- 优先级(Priority)：在作业提交时赋予作业优先级，且在运行中生效（如，它们生命期）。

- 进程追踪(Process tracking，为了信号控制)：提供用于确认各作业关联的进程，可用于作业记账及信号控制。

- 调度器(Scheduler)：用于决定Slurm何时及如何调度作业的插件。

- 节点选择(Node selection)：用于决定作业分配的资源插件。

- 站点因子(Site Factor，站点优先级)：将作业多因子组件中的特殊的site_factor优先级在作业提交时赋予作业，且在运行中生效（如，它们生命期）。

- 交换及互联(Switch or interconnect)：用于网络交换和互联接口的插件。对于多数网络系统（以太网或InifiniBand）并不需要。

- 作业亲和性(Task Affinity)：提供一种用于将作业和其独立的任务绑定到特定处理器的机制。

- 网络拓扑(Network Topology)：基于网络拓扑提供资源选择优化，用于作业分配和提前预留资源。

## 2 规划准备  

- 集群名：MyCluster

- 管理节点: xhpc

  - 内网IP：127.0.0.1  

  - 配置文件： /opt/slurm/22.05.5/etc 目录下的 cgroup.conf 、 slurm.conf 、 slurmdbd.conf 等文件  

  - 需要启动（按顺序）的守护进程服务：  
  ---
  - 通信认证：munge

  - 系统数据库：mariadb（也可采用文本保存，更简单，本文不涉及）

  - Slurm数据库：slurmdbd

  - 主控管理器：slurmctld  

  ---  

- 数据库节点（运行slurmdbd服务）xhpc：
- 用户登录节点xhpc

[1]:http://hmli.ustc.edu.cn/doc/linux/slurm-install/slurm-install.html
[2]:http://slurm.schedmd.com/
[3]:https://xh125.github.io/images/Slurm/arch.gif
