---
layout:     post
title:      "QUANTUM ESPRESSO：bands"
date:       2021-12-15 16:56:00
author:     "Xiehua"
header-img: "images/post/post-bg-understand.jpg"
tags:
    - QUANTUM ESPRESSO
    - bands
---

## QUANTUM ESPRESSO：[bands.x](http://www.quantum-espresso.org/Doc/INPUT_BANDS.html)

采用scf计算得到电荷密度和波函数进行bands计算，非自洽（bands）计算能带

设置`nscf-bands.in`文件,需要修改的参数包括：`calculation`,`nbnd`,`K_POINTS`  

```fortran
&CONTROL
    calculation   = "bands"  
    restart_mode  = "from_scratch"
    prefix        = "carbyne"
    outdir        = "./outdir/"
    pseudo_dir    = "./pseudo/"
    verbosity     = "high"
    tprnfor       = .true.  
    tstress       = .true.
    etot_conv_thr =  1.0d-6
/

&SYSTEM
    ibrav       = 6
    celldm(1)   = 18.89726125
    celldm(3)   = 0.256551169
    nat         = 2
    ntyp        = 1
    nbnd        = 22
    occupations = 'fixed'
    ecutwfc     =  50
    ecutrho     =  400
/

&ELECTRONS
    conv_thr         =  1.000e-9
    electron_maxstep =  200
    mixing_beta      =  0.7
    startingpot      = "atomic"
    startingwfc      = "atomic+random"
/

K_POINTS crystal_b
2
0.0 0.0 -0.5  400
0.0 0.0  0.5  1   

ATOMIC_SPECIES
C      12.01070  C.pbe-n-kjpaw_psl.1.0.0.UPF

ATOMIC_POSITIONS (angstrom)
C             5.0000000000       5.0000000000       0.0000000000    0   0   0
C             5.0000000000       5.0000000000       1.2640744811    0   0   1
```

### NSCF-bands计算完成后，使用[bands.x](http://www.quantum-espresso.org/Doc/INPUT_BANDS.html)程序来处理得到态密度，输入文件`bands.in`如下  

```fortran
&bands
prefix = 'carbyne'
outdir = './outdir'
filband = 'carbyne.bands.dat'
lsym = .true.
/
```

对文件carbyne.bands.dat使用Originlab作图，并将能量减去VBM值，使得VBM=0  ，能带结构如下：  
![bands](https://xh125.github.io/images/post/bands.png)  

### 计算完能带后使用[projwfc.x](http://www.quantum-espresso.org/Doc/INPUT_PROJWFC.html)计算投影能带(Pbands)进行fatband处理，用来得到Wannier拟合的初始函数指定

依次运行pw.x、projwfc.x，在能带计算之后，用projwfc.x生成的fatband文件，可以和bands.x生成的文件carbyne.bands.dat结合画出各个能带的原子轨道投影，[画图脚本如下](https://yyyu200.github.io/DFTbook/blogs/2019/04/01/HandsOn)：

输入文件projwfc.in如下：  

```fortran
&projwfc
prefix = 'carbyne'
outdir = './outdir'
lsym = .false.
filproj = 'fatband'
/
```

画图脚本：

```fortran
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
@author: yyyu200@163.com
"""

import numpy as np

# plot range for y-axis
ymin=-23
ymax=10
dline=30 # vertical line intervals
lw=0.5 # line width
nband=26 # highest valence band

feig=open('bd.dat')
l=feig.readline()
nbnd=int(l.split(',')[0].split('=')[1])
nks=int(l.split(',')[1].split('=')[1].split('/')[0])

eig=np.zeros((nks,nbnd),dtype=float)
for i in range(nks):
    l=feig.readline()
    count=0
    if nbnd%10==0:
        n=nbnd//10
    else:
        n=nbnd//10+1
    for j in range(n):
        l=feig.readline()
        for k in range(len(l.split())):
            eig[i][count]=l.split()[k]
            count=count+1

feig.close()

import matplotlib as mpl
mpl.use('Agg')
import matplotlib.pyplot as plt

F=plt.gcf()
F.set_size_inches([4,5])
p1=plt.subplot(1, 1, 1)

eig_vbm=max(eig[:, nband-1])
#eig_vbm= 0.00 # fermi energy level in scf output for metals
for i in range(nbnd):
    line1=plt.plot(np.arange(0,nks), eig[:,i]-eig_vbm,color='grey',linewidth=lw )

vline=dline
while vline<nks-1:
    plt.axvline(x=vline, ymin=ymin, ymax=ymax,linewidth=lw,color='black')
    vline=vline+dline

elem=['Sn','O']
ielem=np.array([2,4],dtype=np.int32) # number of atoms for each element
orb=[['s','p','d'],['s','p']]  # projectors for each element

N=len(elem)
iorb=np.zeros([N,],dtype=np.int32)  # number of projectors for each element
for i in range(N):
    iorb[i]=len(orb[i])

lorb=np.zeros([N,],dtype=np.int32) # number of local orbital for each element
for i in range(N):
    for j in orb[i]:
        if j is 's':
            lorb[i]+=1
        elif j is 'p':
            lorb[i]+=3
        elif j is 'd':
            lorb[i]+=5
        elif j is 'f':
            lorb[i]+=7
        else:
            print("unexpect: ",j)
            assert False

nlorb=np.dot(ielem,lorb)

pjsum=np.zeros([nlorb, nks, nbnd], dtype=np.float32)

filproj=open('sno.projwfc_up')
nline_io_header=14 # line number at '    F    F'

for i in range(nline_io_header):
    filproj.readline()

for i in range(nlorb):
    filproj.readline()
    for j in range(nks):
        for k in range(nbnd):
            pjsum[i,j,k]=float(filproj.readline().split()[2])

nplotline=np.sum(iorb)
# oo, orbital index for each kind of color, oo can be generated by the following commands
#grep '[a-zA-Z]' sno.projwfc_up |grep 2P|awk '{printf( $1-1",")}'
oo=[[0,9],
[1,2,3,10,11,12],
[4,5,6,7,8,13,14,15,16,17],
[18,22,26,30],
[19,20,21,23,24,25,27,28,29,31,32,33]]

s_of_o=np.zeros([nks,],dtype=np.float32)
color=['r','g','orange','cyan','blue']
label=['Sn s','Sn p','Sn d','O s','O p']

scale=90.0
st=[]
for i in range(len(oo)):
    for k in range(nbnd):
        s_of_o=np.zeros([nks,],dtype=np.float32)
        for j in oo[i]:
            s_of_o[:]+=pjsum[j,:,k]
        if k == 0:
            st.append(plt.scatter(-1, ymin-1, 20, c=color[i], alpha=0.5, label=label[i],marker='.',edgecolor='none'))
        st.append(plt.scatter(np.arange(0,nks), eig[:,k]-eig_vbm, s=scale*s_of_o, c=color[i], alpha=0.5, marker='.',edgecolor='none'))

plt.xlim([0,nks-1]) # 201 points
plt.ylim([ymin,ymax])
plt.ylabel(r'E (eV)',fontsize=16)
plt.xticks((0,30,60), ('M', r'${\Gamma}$', 'Z') )

plt.subplots_adjust(left=0.20, right=0.75, top=0.95, bottom=0.1)
p1.legend(scatterpoints =1, numpoints=1,markerscale=2.0, bbox_to_anchor=(1.05, 1), loc='upper left', borderaxespad=0.)

plt.savefig('pjband.png',dpi=400)
```

得到投影能带（Pjbands）如下：

![pdos](https://xh125.github.io/images/post/pjbands.png)  