---
layout:     post
title:      "QUANTUM ESPRESSO：EPW"
date:       2021-12-16 22:56:00
author:     "Xiehua"
header-img: "images/post/post-bg-understand.jpg"
tags:
    - QUANTUM ESPRESSO
    - DFPT
    - EPW
---

## QUANTUM ESPRESSO：[epw.x计算electron-phonon coupling](https://epw-code.org/)

EPW is an open-source community code for ab initio calculations of electron-phonon interactions using Density-Functional Perturbation Theory and Maximally Localized Wannier Functions.

计算步骤如下：  

1. 第一步：进入phonon目录进行scf自洽计算  
   `pw.x <scf.in> scf.out`  
   **NOTE:** `outdir`需要设置为”./”,由于后面需要对ph.x计算的结果使用pp.py进行收集。

2. 使用`ph.x`进行DFPT计算，得到dvscf文件：  
   **Note:** set:  

   ```fortran
    outdir = './'
    fildyn = 'graphene.dyn'
    fildvscf = 'dvscf'
    ```  

   * 第二步：ph.x进行DFPT计算（最费时间，需要注意设置参数`fildyn`和`fildvscf`)  
     在phonon计算中可以使用 [`-nimage N`](http://www.quantum-espresso.org/Doc/INPUT_PH.html#idm357) 参数进行并行计算，可以在不同的节点上计算不同的q点，也可以不同的任务提交不同的q点，然后进行后续处理，这样比较省机时，但是处理起来比较麻烦。On parallel machines the q point and the irreps calculations can be split
     automatically using the -nimage flag. See the phonon user guide for further
     information.  

     ```bash
     mpirun -np $NP -machinefile ${CURDIR}/nodelist ph.x -ni 6 -npool 28 <ph.in> ph.out`
     ```    


3. 第三步：使用pp.py收集ph.x计算得到的fildvscf相关文件到save文件夹。对于使用paw赝势计算的结果，需要采用修改版的[pp-paw.py](https://github.com/xh125/LVCSH-mpi/tree/main/tools/pp-paw.py)进行处理

4. 第四步进入epw目录，先进行scf计算（或者将phonon目录中的内容拷贝过来），再进行nscf计算，需要采用homogeneous kpoint grid进行nscf计算

    `kmesh.pl 12 12 1 >>${prefix}.nscf.in`

   需要修改`calculation=nscf`、`nbnd=`  
   *Note：*`nbnd`的设置需要使得每个k点都包含所有的投影波函数的信息，通过fatband的能带图去看nbnd是否足够。  

5. 第五步设置epw.in文件，进行epw计算.先不用计算任何性质，主要是为了确定得到wannier函数求取成功，并得到wannier表象下的电神耦合矩阵，用于后续计算。注意fsthick的设置，会影响打印出来的电声耦合矩阵元包含的能带数和q点数。
    *note:* dis_win_max的值要根据fatband的结果进行设置，不能随意设置的无限高或者不设置，这样会导致得到的wannier函数很难局域化。四个能量窗口都需要根据fatband的结果仔细的设置。  

epw.in

```fortran
epw calculation of graphene
&inputepw
  prefix = 'graphene'
  outdir = './'
  amass(1)= 12.0107
  dvscf_dir = '../phonon/save'

  iverbosity = 0

  elph        = .true.
  epbwrite    = .false.
  epbread     = .false.
  epwwrite    = .true.
  epwread     = .false.
  etf_mem     = 1
  prtgkk   = .false.

!  eig_read    = .true.

!  asr_typ     = 'one-dim'
!  use_ws      = .true.

  wannierize = .true.
  nbndsub     =  6
!  bands_skipped = 'exclude_bands = 1-2'
  num_iter = 30000
  iprint   = 2
  dis_win_max = 25.0
  dis_win_min = -25.0
  dis_froz_min = -4.5
  dis_froz_max = 1.4
  proj(1) = 'C:sp2'
  wannier_plot= .true.
  wannier_plot_supercell = 5 5 1
!  wdata(1)= 'bands_plot = .true.'
!  wdata(2)= 'begin kpoint_path'
!  wdata(3)= 'G 0.00 0.00 0.00  M 0.50 0.00 0.00'
!  wdate(4)= 'M 0.50 0.00 0.00  K 0.3333 0.3333 0.00'
!  wdate(5)= 'K 0.3333 0.3333 0.00  G 0.00 0.00 0.00'
!  wdata(6)= 'end kpoint_path'
!  wdata(7)= 'bands_plot_format = gnuplot'
  wdata(8)= 'conv_tol      = 1.0e-10 '
  wdata(9)= 'conv_window   = 10      '
  wdata(10)= 'dis_conv_tol  = 1.0e-10 '
  wdata(11)= 'dis_conv_window = 5     '
  wdata(12)= 'dis_num_iter= 30000      '
  wdata(13)= 'dis_mix_ratio= 0.5      '
  wdata(14)= 'guiding_centres = .true.'
  wdata(15)= 'translate_home_cell  : true'
  wdata(16)= 'translation_centre_frac :   0.0 0.0 0.0  '

  elecselfen  = .false.
  phonselfen  = .false.
  a2f         = .false.

  fsthick     = 5.0 ! eV
  temps       = 300 ! K
  degaussw    = 0.005 ! eV

!  band_plot   = .true.
!  filkf       = './LGX.txt'
!  filqf       = './LGX.txt'

  nkf1 = 12
  nkf2 = 12
  nkf3 = 1
  nqf1 = 12
  nqf2 = 12
  nqf3 = 1

  nk1 = 12
  nk2 = 12
  nk3 = 1
  nq1 = 12
  nq2 = 12
  nq3 = 1
/ 
```  

作业提交bsub脚本：`qe-epw.bsub`
```bash
#!/bin/bash
#BSUB -J epw
#BSUB -q privateq-zw
##BSUB -q publicq
#BSUB -n 28
#BSUB -R "span[ptile=28]"
#BSUB -o %J.out
#BSUB -e %J.err

CURDIR=$PWD
rm -f nodelist >& /dev/null
for host in `echo $LSB_HOSTS`
do
echo $host >> nodelist
done
NP=`cat nodelist | wc -l`

prefix='graphene'
#source ~/xiehua/.bashrc
#export OMP_NUM_THREADS=1
#export MKL_NUM_THREADS=1
export MODULEPATH=/share/home/zw/xiehua/modulefiles:$MODULEPATH

module load Quantum_Espresso/7.0

#mpirun -np $NP pw.x -nk 7 <vc-relax.in>vc-relax.out
#mpirun -np $NP pw.x -nk 7 <scf.in>scf.out
#mpirun -np $NP pw.x -nk 7 <nscf.in> nscf.out
#wannier90.x -pp ${prefix}
#pw2wannier90.x < pw2wan.in > pw2wan.out
#mpirun -np $NP wannier90.x ${prefix}
mpirun -np $NP epw.x -npool $NP <epw.in > epw.out
```
   * [**EPW声子谱和QE不一致**](https://www.jianshu.com/p/e5e34d576c86) (参考简书)  
      这个问题一般是由于声子求和规则导致的，EPW中提供了读入实空间力常数来计算声子频率的方法，并且也提供了相应的声子求和规则（与matdyn.f90里面的相同）。只需要改[**`lifc = .true.`**](https://docs.epw-code.org/doc/Inputs.html#lifc)，然后再设置声子求和规则[**`asr_typ = crystal`**](https://docs.epw-code.org/doc/Inputs.html#asr-typ)（我一般都取crystal），同时需要注意的是要保证之前计算QE得到的文件通过pp.py收集起来那个必须有q2r.x产生的实空间力常数文件并且已经被命名为 **ifc.q2r**，对于包含SOC的情况，这个文件必须叫 **ifc.q2r.xml** 并且是xml格式的文件。（这个一般不是太老的脚本pp.py都会自动帮你做这件事情。）参考[phonon bandstructure from EPW and matdyn.x don't match](https://forum.epw-code.org/index.php?f=3&t=137)  

       ```fortran  
       &input  
       fildyn='carbyne.dyn', zasr='simple', flfrc='ifc.q2r'  
       /  
       ```



6.采用5步中计算成功后的结果，使用第五步`epwwrite=.true.`设置输出的wannier表象下的电声耦合文件，计算不同`nqf`和`nkf`插值密度的EPW计算。采用脚本`runepw.sh`计算其他插值q点和k点情况下的电神耦合矩阵元，并输出gmnvkq矩阵元。  

```bash
#!/bin/bash
for i in $(seq 6 6 36)
  do
  cp epw.in epw${i}.in
  sed -i "s:epwwrite:epwwrite=.false. ! :g" epw${i}.in
  sed -i "s:epwread:epwread=.true. !:g" epw${i}.in
  sed -i "s:epbread:epbread=.false. !:g" epw${i}.in
  sed -i "s:epbwrite:epbwrite=.false. !:g" epw${i}.in
  sed -i "s:prtgkk:prtgkk=.true. !:g" epw${i}.in
  sed -i "s:wannierize:wannierize=.false. !:g" epw${i}.in
  sed -i "s:wannier_plot:wannier_plot=.false. !:g" epw${i}.in
  sed -i "s:elecselfen:elecselfen=.false. !:g" epw${i}.in
  sed -i "s:fsthick:! fsthick:g" epw${i}.in

  sed -i "s:nkf1:nkf1=$i !:g" epw${i}.in
  sed -i "s:nkf2:nkf2=$i !:g" epw${i}.in  
# sed -i "s:nkf3:nkf3=$i !:g" epw${i}.in   
  sed -i "s:nqf1:nqf1=$i !:g" epw${i}.in
  sed -i "s:nqf2:nqf2=$i !:g" epw${i}.in  
# sed -i "s:nqf3:nqf3=$i !:g" epw${i}.in 

  cp qe-epw.bsub qe-epw${i}.bsub
  sed -i "2s:epw:epw${i}:g" qe-epw${i}.bsub
  sed -i "s:epw.in:epw${i}.in:g" qe-epw${i}.bsub
  sed -i "s:epw.out:epw${i}.out:g" qe-epw${i}.bsub	

  bsub < qe-epw${i}.bsub
  sleep 10
  done
```
7. 采用较密的k点和q点计算电子自能，用于计算电子弛豫时间。使用脚本`runepwmkq.sh`  

```bash
#!/bin/bash
for i in $(60)
  do
  cp epw.in epw${i}.in
  sed -i "s:epwwrite:epwwrite=.false. ! :g" epw${i}.in
  sed -i "s:epwread:epwread=.true. !:g" epw${i}.in
  sed -i "s:epbread:epbread=.false. !:g" epw${i}.in
  sed -i "s:epbwrite:epbwrite=.false. !:g" epw${i}.in
  sed -i "s:prtgkk:prtgkk=.false. !:g" epw${i}.in
  sed -i "s:wannierize:wannierize=.false. !:g" epw${i}.in
  sed -i "s:wannier_plot:wannier_plot=.false. !:g" epw${i}.in
  sed -i "s:elecselfen:elecselfen=.true. !:g" epw${i}.in
  
  sed -i "s:nkf1:nkf1=$i !:g" epw${i}.in
  sed -i "s:nkf2:nkf2=$i !:g" epw${i}.in  
# sed -i "s:nkf3:nkf3=$i !:g" epw${i}.in   
  sed -i "s:nqf1:nqf1=$i !:g" epw${i}.in
  sed -i "s:nqf2:nqf2=$i !:g" epw${i}.in  
# sed -i "s:nqf3:nqf3=$i !:g" epw${i}.in 

  cp qe-epw.bsub qe-epw${i}.bsub
  sed -i "2s:epw:epw${i}:g" qe-epw${i}.bsub
  sed -i "s:epw.in:epw${i}.in:g" qe-epw${i}.bsub
  sed -i "s:epw.out:epw${i}.out:g" qe-epw${i}.bsub	

  bsub < qe-epw${i}.bsub
  done
```

8.EPW运算过程中可能遇到的报错问题。  
  （1）在epw.x运算过程中可能遇到报错如下：  

```bash
     Fermi energy coarse grid =  -1.703677 eV

 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
     Error in routine efermig (1):
     internal error, cannot bracket Ef
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

     stopping ...

```  
该问题可能导致的原因，参考[EPW Forum](https://forum.epw-code.org/viewtopic.php?f=3&t=1604&p=4483&hilit=internal+error%2C+cannot+bracket+Ef#p4483)
可能的解决方案包括：1.使用更多的Wannier函数进行求解局域的WFs。2.使用`bands_skipped = 'exclude_bands = 1-16'`排除部分能带。3.`dis_win_min`一般不需要设置。

例如，对于graphene的epw的计算，需要设置`proj(1) = 'C:pz,px,py'`,虽然Wannier拟合只需要采用`proj(1) = 'C:pz'`即可完成拟合。
